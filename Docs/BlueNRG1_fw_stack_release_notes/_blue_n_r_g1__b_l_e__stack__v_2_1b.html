<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>BlueNRG-1,2 Bluetooth Low Energy Stack: BlueNRG-BLE Stack Library v_2_1b (06-March-2020)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="STcustom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST-logo-small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BlueNRG-1,2 Bluetooth Low Energy Stack
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">BlueNRG-BLE Stack Library v_2_1b (06-March-2020) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="S1"></a>
Bluetooth Low Energy (BLE) stack binary image files</h1>
<p>This section lists the <b>BlueNRG-BLE Stack Library</b> binary file to be used for the BlueNRG-1, BlueNRG-2 Systems On Chip configuration: <br />
</p>
<ul>
<li>libbluenrg1_stack.a binary library <b>v2.1b</b> with following main new features: <ul>
<li>
MISRA-C:2012 compliance </li>
<li>
Bluetooth LE Data Packet Length extension support: LL-PDU data payload up to 251 bytes (only for BlueNRG-2 devices). </li>
<li>
BLE stack modular configurations allowing to optimize BLE stack memory footprints based on user application scenario. </li>
</ul>
</li>
<li><b>NOTES</b>: <ul>
<li>
libbluenrg1_stack.a binary library file <b>v2.1b</b> is available on folder: <b>Library\Bluetooth_LE\library </b>. The binary file must be linked to the built user application in order to get access to the BLE stack features. </li>
<li>
libbluenrg1_stack.a is valid for all the supported toolchains: IAR-EWARM, ARM Keil MDK and Atollic TrueStudio. </li>
<li>
When adding libbluenrg1_stack.a on a Keil project, just change the related File Type to Library File (from file Options). </li>
<li>
Configuration files stack_user_cfg.[c/h] are used for enabling the BLE stack v2.1b modular approach </li>
<li>
AES CMAC encryption functionality required by BLE stack v2.1b is available on new standalone binary library: Library\cryptolib\cryptolib.a</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="S10"></a>
BLE stack modular configurations options</h2>
<ul>
<li>The following <b>BlueNRG-BLE Stack Library</b> modular configurations options are currently supported: <ol>
<li>
<b>BLE_STACK_CONFIGURATION=BLE_STACK_FULL_CONFIGURATION</b> &ndash;&gt; preprocessor option to be added on BLE user application IDE toolchain, for configuring the BLE stack with all supported modular features: <ul>
<li>
Controller Privacy is enabled </li>
<li>
LE Secure Connection is enabled </li>
<li>
Master role is enabled </li>
<li>
Data length extension is enabled (valid only for BlueNRG-2 devices) </li>
</ul>
</li>
<li>
<b>BLE_STACK_CONFIGURATION=BLE_STACK_BASIC_CONFIGURATION</b> &ndash;&gt; preprocessor option to be added on BLE user application IDE toolchain for configuring the BLE stack with the basic configuration options: <ul>
<li>
Controller Privacy is disabled </li>
<li>
LE Secure Connection is disabled </li>
<li>
Master role is disabled (only Peripheral/Slave role is supported) </li>
<li>
Data length extension is disabled </li>
</ul>
</li>
<li>
<b>BLE_STACK_CONFIGURATION=BLE_OTA_BASIC_CONFIGURATION</b> &ndash;&gt; preprocessor option to be added on BLE user application IDE toolchain for selecting the OTA Service support with Data length extension (valid only for BlueNRG-2 device): <ul>
<li>
Controller Privacy is disabled </li>
<li>
LE Secure Connections is disabled </li>
<li>
Master role is disabled (only Peripheral/Slave role is supported) </li>
<li>
Data length extension is enabled (only for BlueNRG-2 device) </li>
</ul>
</li>
</ol>
</li>
<li>NOTES: <ul>
<li>
Data length extension must be disabled on each configuration related to a BlueNRG-1 device (it doesn't support this feature). </li>
<li>
Files stack_user_cfg.[c/h] must not be modified by user. </li>
<li>
<b>BLE_STACK_CONFIGURATION=BLE_STACK_BASIC_CONFIGURATION</b> is the default option. If no value is defined for the preprocessor option BLE_STACK_CONFIGURATION on IDE toolchain, the BLE_STACK_BASIC_CONFIGURATION is selected. </li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="S11"></a>
Bluetooth Low Energy (BLE) stack network coprocessor configuration</h1>
<ul>
<li>Two network coprocessor modes are supported: SPI and UART (mainly for RF evaluation purpose). </li>
<li>The network coprocessor over SPI specification aims at achieving the following targets: <ul>
<li>
Very similar to BlueNRG, BlueNRG-MS protocol </li>
<li>
Power efficient </li>
<li>
Code efficient </li>
<li>
Fast data transfer </li>
</ul>
</li>
<li>DTM project and related workspaces provides reference appplications for configuring the BlueNRG-1 platforms (STEVAL-IDB007Vx (x=1,1M,2)) or BlueNRG-2 platforms (STEVAL-IDB008Vx (x=1,1M,2)) as a network coprocessor (refer to BlueNRG-1_2 DK Release notes documentation for more information).</li>
</ul>
<h1><a class="anchor" id="S12"></a>
New Features</h1>
<p>This section lists the new features compared to <b>BlueNRG-BLE Stack Library</b> v2.1a<br />
</p>
<ul>
<li>New Bluetooth Low Energy binary file: <b>BlueNRG-BLE Stack Library</b> v2.1b: <ul>
<li>
Added support of Expedited Errata Correction 11838 (Encryption Key Size Updates). </li>
<li>
Added support of Device privacy mode when controller privacy is enabled. </li>
<li>
Added hci_le_set_privacy_mode() API which allows the Host to specify the privacy mode to be used for a given entry on the resolving list. </li>
<li>
Added hci_tx_acl_data() API and hci_rx_acl_data_event() event declarations, respectively, on bluenrg1_api.h and bluenrg1_events.h.</li>
</ul>
</li>
<li>Updated bluenrg1_stack.h: TOTAL_BUFFER_SIZE macro. </li>
<li>Updated bluenrg1_api.h, bluenrg1_events.h:<ul>
<li>
added hci_tx_acl_data() API and hci_rx_acl_data_event() </li>
<li>
fixes in comment indentation </li>
<li>
changed type to int8_t for Transmit_Power_Level and RSSI parameters.</li>
</ul>
</li>
<li>Updated stack_user_cfg.c: removed GAP_LimDiscTimeoutcb_ucfg().</li>
</ul>
<ul>
<li>NOTES: <ul>
<li>
Refer to <a href="../BlueNRG1_BLE_stacks_migration/ble__stacks__migration_8h.html">Bluetooth LE Stack v1.x to v2.x migration guideline html documentation </a> for information about how to port an application from BLE stack v1.x to v2.0, v2.1x and later. </li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="S13"></a>
Solved Issues</h1>
<p>This section lists the solved issues compared to <b>BlueNRG-BLE Stack Library</b> v2.1a<br />
</p>
<ul>
<li>ID 6793 Possible disconnection for MIC failure (0x3D) when encrypting the link </li>
<li>ID 6787 Possible hard fault of GATT Server if a tx-ed response packet is processed after a disconnection </li>
<li>ID 6780 A GATT Timeout on the n-th link causes reset of ATT Bearer on first link (no GATT procedures are allowed) </li>
<li>ID 6773 Improved robustness against sequential ATT request attack in multi-connection scenario </li>
<li>ID 6766 Repeated attempts protection (blacklist) policy now applied also on pairing failure during Phase 1 (Feature Exchange). </li>
<li>ID 6739 L2CAP Recombination issue when handling Start fragments with not completed L2CAP Header. </li>
<li>ID 6717 Pairing Request command not blocked during Link Key refresh operations. </li>
<li>ID 6701 ACI_Gap_Set_Authentication_Requirements corrupts the OOB DATA. </li>
<li>ID 6638 When a Prepare Queue Full error is received by the client while performing a Long Write procedure, the queue is now flushed by using an Execute Write Request. Earlier a second long write procedure was automatically started to write the remaining bytes. </li>
<li>ID 6636 HW Error Event in slave + adv/scan scenario </li>
<li>ID 6578 Failure in starting a Secure Connection pairing while another pairing procedure is in progress on another link. </li>
<li>ID 6521 When sending ATT packet with some specific sizes (from 32*N-3 to 32*N-1 bytes, where N=1,2,3...) the last 2 bytes were not correct. </li>
<li>ID 6497 Internal Time Base corruption when Connection Update procedure fails. </li>
<li>ID 6302 Slave is now able to send more than one Slave Security Request packet, in case Master is not able to reply with a Pairing Request </li>
<li>ID 6301 Double pairing complete event (with status failed) after failing numeric comparison. </li>
<li>ID 6169 If a master starts a pairing procedure by forcing a rebond with a previously bonded slave and the slave sends a Slave Security request, a disconnection happens (with MIC failure) on both sides </li>
<li>ID 6160 New SC pairing not working after previous pairing failed (due to not confirmed Numeric Comparison) if new numeric comparison confirmation command is sent too fast. </li>
<li>ID 6159 aci_gap_bond_lost_event is generated on Slave side when Master sends a pairing request during a blacklist period. </li>
<li>ID 5894 Device hangs when receiving a malformed packet while in a discovery procedure </li>
<li>ID 5808 SC Pairing failed in case of Encryption Key Size &lt; 16 (disconnection with MIC Failure) </li>
<li>ID 5807 Slave ignores Pairing Request in case of previous pairing failure (on Master) with Numeric Comparison association. </li>
<li>ID 5443 If the Link Layer receives an HCI ACL Data Packet with Data_Total_Length equal to 0, a wrong LLID is used. </li>
<li>ID 4197 If a BlueNRG started a write long procedure, but the prepare queue size was 0 on on the server (i.e. no buffers available even for one packet), the client entered a loop in which it was sending execute write requests.</li>
</ul>
<h1><a class="anchor" id="S14"></a>
Limitations/Bugs</h1>
<p>This section lists the issues known at firmware image release time. Issues found after this release are listed as solved or limitations on newer releases. <br />
</p>
<ul>
<li>ID 6768 When the system clock frequency is 16 MHz and the length update procedure is executed in parallel to high throughput data exchange, fragmentation errors may be detected by the peer device. </li>
<li>ID 5102 One of two consecutive slave connection slots are canceled if close to a scan window. </li>
<li>ID 5919 ACI_Gap_Remove_Bonded_Device command just deletes the Security data but not any related GATT data. </li>
<li>ID 5816 When using the aci_gatt_set_access_permission to change the access permissions of a characteristic value, the characteristic properties inside the characteristic declaration is not automatically changed. </li>
<li>ID 4867 When the device is in the slave role, some connection events are skipped if the Master pushes the duration of the connection event to the limit. </li>
<li>ID 4338 Encryprion may fail in Slave of Multiple Masters scenario. </li>
<li>ID 4190 Scanning filter policy can be used in selective connection establishment procedure, but standard only allows 'accept only' filter policy. </li>
<li>ID 4223 aci_gatt_write_char_value does not support the write of multiple attributes. </li>
<li>ID 4201 aci_gatt_del_service() doesn't update the attribute size table. </li>
<li>ID 4019 Notification issue on multi link scenario </li>
<li>ID 4068 Unexpected disconnection when ACI_GAP_CLEAR_SECURITY_DB command is called on an on-going connection </li>
<li>ID 3919 Maximum number of stored bonding devices cannot be configured </li>
<li>ID 3957 When a prepare write request is received, the application can accept or reject the prepare write request with ACI_GATT_WRITE_RESP but when the execute write request is received, there is no way to reject all the writes. </li>
<li>ID 3894 Scan response addressed to another scanner mistakenly accepted </li>
<li>ID 3508 Slave latency not applied during LL connection parameter update procedure </li>
<li>ID 3475 When host privacy is enabled, application must set the public address to 0xFFFFFFFFFFFF in order to use the static random address as the identity address during pairing. </li>
<li>ID 3108 BLE stack v2.1: Controller Privacy is not supported when using a 16MHz HS crystal. </li>
<li>ID 3049 Timer queue may be corrupted if a timer is stopped inside its callback </li>
<li>ID 3047 Privacy 1.2: Scan_Req sent with Public address in the InitA field (RPA expected) when AdvA is received that cannot be resolved </li>
<li>ID 3035 No indications are sent to any client if a notification packet is already scheduled for TX </li>
<li>ID 2922 No way to specify requirements for Security Mode 1 Level 4 at characteristic level. </li>
<li>ID 2899 aci_gatt_write_char_reliable supports up to 255 bytes of attribute value length </li>
<li>ID 2898 aci_gatt_write_long_char_desc supports up to 255 bytes of attribute value length </li>
<li>ID 2897 aci_gatt_write_long_char_value supports up to 255 bytes of attribute value length </li>
<li>ID 2801 The timer programmed with HAL_VTimerStart_ms() is actually started only after a call to the BTLE_StackTick() </li>
<li>ID 2771 If the RSSI is measured on a link with a device very close to BlueNRG itself, the measured RSSI may be wrongly reported. </li>
<li>ID 2635 In case a long HS STARTUP TIME is used, the advertising interval in High Duty Cycle mode is 7.5 ms instead of 3.75 ms.. </li>
<li>ID 1687 Scanning performed with a maximum duty cycle of 95% </li>
<li>ID 1667 Host commands are not rejected when LinkLayerOnly flag is set </li>
<li>ID 1663 No service changed indication sent to a bonded device if a reset occurs before disconnection to the bonded device </li>
<li>ID 1661 Device may hang for 32s if XO start-up time exceedes the IFR HS_STARTUP_TIME value </li>
<li>ID 1659 Not able to do fast advertise when all the connections have long connection interval</li>
</ul>
<h1><a class="anchor" id="S141"></a>
BLE stack Flash memory footprints (bytes)</h1>
<ul>
<li><b>BLE stack full Flash size (all APIs and events used) </b></li>
</ul>
<table  border="1">
<tr>
<th>Stack version </th><th>Full Stack Size  </th></tr>
<tr>
<td><b> V2.0 </b> </td><td>98 Kb  </td></tr>
<tr>
<td><b> V2.1x </b> </td><td>102 Kb   </td></tr>
</table>
<ul>
<li><b>BLE Sensor Demo application (BlueNRG-1 case): only BLE stack components Flash size </b></li>
</ul>
<table  border="1">
<tr>
<th>Stack version </th><th>Release </th><th>LowerApp_OTA </th><th>HigherApp_OTA </th><th>Use_OTA_ServiceManager </th></tr>
<tr>
<td><b> V2.0 </b> </td><td>73 Kb </td><td>Not supported </td><td>Not supported </td><td>Not supported </td></tr>
<tr>
<td><b> V2.1x (FULL stack Configuration) </b> </td><td>77 Kb </td><td>Not supported </td><td>Not supported </td><td>Not supported </td></tr>
<tr>
<td><b> V2.1x (BASIC stack Configuration) </b> </td><td>58 Kb </td><td>58 Kb </td><td>58 Kb </td><td>58 Kb  </td></tr>
</table>
<ul>
<li><b> NOTES</b>: <ul>
<li>
BlueNRG-1, BLE stack V2.1x Sensor Demo configurations are built with the BLE_STACK_CONFIGURATION=BLE_STACK_BASIC_CONFIGURATION modular option. </li>
<li>
BLE stack V2.0 applications configurations refer to the full stack size option (no modular options are available on BLE stack V2.0).</li>
</ul>
</li>
</ul>
<ul>
<li><b> OTA Service Manager: total application Flash size </b></li>
</ul>
<table  border="1">
<tr>
<th>Stack version/(device)</th><th>FULL stack configuration </th><th>BASIC stack configuration </th><th>BASIC stack + extended data length configuration </th></tr>
<tr>
<td><b> V2.0 (BlueNRG-2) </b></td><td>86 Kb </td><td>Not Applicable </td><td>Not Applicable </td></tr>
<tr>
<td><b> V2.1x (BlueNRG-1) </b></td><td>Not supported </td><td>68 Kb </td><td>Not Applicable </td></tr>
<tr>
<td><b> V2.1x (BlueNRG-2) </b></td><td>Not used </td><td>Not used </td><td>70 Kb  </td></tr>
</table>
<ul>
<li><b> NOTES</b>: <ul>
<li>
OTA Service Manager is not supported on BlueNRG-1, BLE stack v2.0. </li>
<li>
BLE stack V2.0 memory footprints refer to the full stack size option, since no modular options are available on BLE stack V2.0 </li>
<li>
BASIC stack + extended data length configuration (BLE_OTA_BASIC_CONFIGURATION option) enables the Data Length extension feature only on BlueNRG-2 device.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="S142"></a>
BTLE_StackTick Time duration (µs)</h1>
<table  border="1">
<tr>
<th>Stack version </th><th>Only Stack Radio Init </th><th>GATT &amp; GAP init </th></tr>
<tr>
<td><b> V2.0 </b> </td><td>66 </td><td>81  </td></tr>
<tr>
<td><b> V2.1x Basic stack </b> </td><td>54 </td><td>65  </td></tr>
<tr>
<td><b> V2.1x Full stack </b> </td><td>73 </td><td>84   </td></tr>
</table>
<h1><a class="anchor" id="S143"></a>
RAL_Isr Time duration (µs): BLE Advertising,  with advertising interval: 100ms; payload size: 28 bytes</h1>
<table  border="1">
<tr>
<th>Stack version </th><th>TX Channel 1 </th><th>RX Channel 1  </th><th>TX Channel 2 </th><th>RX Channel 2  </th><th>TX Channel 3 </th><th>RX Channel 3  </th></tr>
<tr>
<td><b> V2.0 </b> </td><td>33 </td><td>45 </td><td>33 </td><td>45 </td><td>33 </td><td>103  </td></tr>
<tr>
<td><b> V2.1x Basic stack </b> </td><td>35 </td><td>48 </td><td>35 </td><td>48 </td><td>35 </td><td>118  </td></tr>
<tr>
<td><b> V2.1x Full stack </b> </td><td>35 </td><td>48 </td><td>35 </td><td>48 </td><td>35 </td><td>118   </td></tr>
</table>
<h1><a class="anchor" id="S144"></a>
RAL_Isr Time duration (µs): BLE Connection, with connection interval: 100 ms; no data exchange (only empty packets)</h1>
<table  border="1">
<tr>
<th>Stack version </th><th>RX </th><th>TX </th></tr>
<tr>
<td><b> V2.0 </b> </td><td>63 </td><td>132  </td></tr>
<tr>
<td><b> V2.1x Basic stack </b> </td><td>65 </td><td>149  </td></tr>
<tr>
<td><b> V2.1x Full stack </b> </td><td>65 </td><td>149   </td></tr>
</table>
<h1><a class="anchor" id="S145"></a>
BLE Throughput</h1>
<table  border="1">
<tr>
<th>Stack version </th><th>Unidirectional (ATT_MTU size = 23; no Data Length Extension) </th><th>Bidirectional (ATT_MTU size = 23; no Data Length Extension)  </th><th>Unidirectional (ATT_MTU size = 247; Data Length Extension = 251 on Peripheral side)  </th><th>Bidirectional (ATT_MTU size = 247; Data Length Extension = 251 on both Peripheral and Central sides) </th></tr>
<tr>
<td><b> V2.1x </b> </td><td>~220 kbps </td><td>~166 kbps  </td><td>~740kbps  </td><td>~390 kbps   </td></tr>
</table>
<ul>
<li><b> NOTES</b>: <ul>
<li>
Unidirectional: GAP Peripheral performs characteristic notification to GAP Central. </li>
<li>
Bidirectional: GAP Peripheral performs characteristic notification to GAP Central and GAP Central performs characteristic write without response to GAP Peripheral. </li>
<li>
ATT_MTU size = 247 bytes; Data Length Extension = 251 only on BlueNRG-2 device with BLE stack v2.1x </li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="S15"></a>
Documentation</h1>
<ul>
<li>Refer to <a href="../BlueNRG1_aci_events/files.html">Bluetooth Low Energy (BLE) API and events html documentation </a> for detailed description of BLE stack APIs and related events callbacks. </li>
<li>Refer to <a href="../BlueNRG1_BLE_stacks_migration/ble__stacks__migration_8h.html">BLE stack migration guidelines from v1.x to v2.x html documentation </a> for guidelines about how to migrate applications from Bluetooth low energy stack v1.x to v2.x. </li>
</ul>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Copyright &copy; 2020 by STMicrolectronics. All rights reserved.<br>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
