<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>Multiple Connections Formula: 2) How the formula works?</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="STcustom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST-logo-small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Multiple Connections Formula
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">2) How the formula works? </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>Based on the Num_Slaves number, the formula must define the minimum, optimized Anchor Period length taking in account the following data:<ol>
<li>
The guard time used by the BLE stack between two consecutive Master slots and between the last slot (GuardTime = 1.6 ms) </li>
<li>
The guard time used by the BLE stack between the last slot and the end of the Anchor Period (GuardTimeEnd = 2.6 ms) </li>
<li>
The Master Slot length (CE_Length_ms) </li>
<li>
The advertising event length (14.6 ms) </li>
<li>
The required minimum Scan Window length </li>
</ol>
</li>
</ul>
<ul>
<li>Since formula is defined for supporting simultaneously advertising and scanning, in order to setup Master and Slaves multiple connections, the Scan window length and Advertising event length contributions to the Anchor Period Length are as follow: <ul>
<li>
Scan_Window_ms = round_to_x(round_to_x(Scan_Window+GuardTime,CE_Length_ms+GuardTime) - GuardTime, 0.625) <ul>
<li>
NOTE: Scan_Window+GuardTime is rounded to next multiple of (CE_Length_ms+GuardTime), to avoid possible fragmentation in the Master slots allocation within the Anchor period (using round_to_x() function) </li>
</ul>
</li>
<li>
ADV_LEN_MS = 14.6 ms (to be considered only if Num_Masters &gt; 0) </li>
</ul>
</li>
</ul>
<ul>
<li>As consequence, the Anchor Period Length, in ms, is calculated through the following components: <ol>
<li>
The guard time used by the BLE stack between two consecutive Master slots: <ul>
<li>
(Num_Slaves-1) * ( GuardTime) [1]</li>
</ul>
</li>
<li>
The Master Slot length (CE_Length_ms): <ul>
<li>
(Num_Slaves-1) * (CE_Length_ms) [1] </li>
</ul>
</li>
<li>
The advertising event length (only if Num_Masters &gt; 0): <ul>
<li>
ADV_LEN_MS </li>
</ul>
</li>
<li>
The Scan Window length: <ul>
<li>
Scan_Window_ms (as previously defined) </li>
</ul>
</li>
<li>
Additional_time = max(Sleep_Time, GuardTimeEnd) (at least, it is the guard time at the end of the Anchor Period) </li>
</ol>
</li>
</ul>
<ul>
<li>[1] The time required for the last Master slot is included in the timing calculated for the Scan window length, since once the last connection is established, the scan slot is replaced by a new Master slot.</li>
</ul>
<ul>
<li>AnchorPeriodLength value in ms is defined with this formula (value is rounded to 1.25 ms with round_to_x() function): <ul>
<li>
Num_Masters &gt;0 (Master_Slave device enters in advertising mode): <ul>
<li>
AnchorPeriodLength = round_to_x((Num_Slaves-1)*(CE_Length_ms+GuardTime) + ADV_LEN_MS + Scan_Window_ms + Additional_time, 1.25) </li>
</ul>
</li>
<li>
Num_Masters = 0 (Master_Slave device doesnâ€™t need to enter in advertising mode): <ul>
<li>
AnchorPeriodLength = round_to_x((Num_Slaves-1)*(CE_Length_ms+GuardTime) + Scan_Window_ms + Additional_time, 1.25)</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>Based on the calculated Anchor Period Length in ms and on the multiple master and slave connection guidelines, the Master_Slave device connections parameters in ms are defined as follow: <ul>
<li>
Connection_Interval_ms = AnchorPeriodLength (refer to Guideline M2: connection interval is a integer multiple of the anchor period. The minimum multiple is selected for optimizing the throughput). </li>
<li>
Advertising_Interval_ms = Connection_Interval_ms-5 (Refer to Guideline A2, 2: (Advertising_Interval_ms + 5) is a integer multiple of the shortest allocated connection interval)) </li>
<li>
Scan_Interval_ms = Connection_Interval_ms (Refer to Guideline S2: Choose a LE_Scan_Interval greater or equal to the periodicity (i.e. Advertising Interval or Connection Interval) of one of the existing Master slots) </li>
<li>
Scan_Window: user defined value rounded to next multiple of CE_Length_ms with round_to_x() function</li>
</ul>
</li>
</ul>
<ul>
<li>The defined connection parameters are then expressed in terms of internal unit time, in order to be used from the BLE stack APIs, and returned to the user application as follow: <ul>
<li>
Connection_Interval = int(Connection_Interval_ms/1.25) </li>
<li>
Advertising_Interval = int(Advertising_Interval_ms/0.625) </li>
<li>
CE_Length = int(CE_Length_ms/0.625) </li>
<li>
Scan_Interval = int(Scan_Interval_ms/0.625) </li>
<li>
Scan_Window = int(Scan_Window_ms/0.625) </li>
</ul>
</li>
</ul>
<ul>
<li>A <a href="./Multiple_Connection_Formula_Timings_Chart.xlsx">Multiple Connection Formula Timings Chart spreadsheet</a> is provided in order to allow user to emulate the formula calculation and to determine the multiple connections parameters values for his specific application scenario. </li>
<li>The spreadsheet also provides a timing chart of the allocated slots. </li>
</ul>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Copyright &copy; 2020 by STMicrolectronics. All rights reserved.<br>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
