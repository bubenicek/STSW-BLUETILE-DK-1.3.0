<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>Multiple Connections Formula: 3) How to use the formula ? (Master_Slave demo application and Slaves, Master scripts example)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="STcustom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST-logo-small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Multiple Connections Formula
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">3) How to use the formula ? (Master_Slave demo application and Slaves, Master scripts example) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><b>Master of multiple Slaves</b>: <ul>
<li>
One Master_Slave device connected up to 8 Slaves devices (Master device is not a slave of any other Master devices) </li>
</ul>
</li>
<li>User must define the following input parameters for the formula: <ul>
<li>
Num_Masters = 0 </li>
<li>
Num_Slaves &lt;=8 (number of slave devices to be supported) </li>
<li>
Scan_Window = &lt;value&gt; (&lt;value&gt; is the scan window value in ms used by Master_Slave device during its scanning operations for discovering each Slave device) </li>
<li>
Additional_time = 0 (no additional time added: it provides the best data throughput). User could add a value greater than 0, if he wants to improve the power consumption profile. </li>
</ul>
</li>
<li>This implies to use the formula as follow: <ul>
<li>
<b>GET_Master_Slave_device_connection_parameters(0, 8,20,0)</b> </li>
</ul>
</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_2.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 2: Master_Slave device: multiple connections to up 8 Slave devices </b>  </td></tr>
</table>
<ul>
<li>The formula returns the following parameters to be used on the BLE APIs: <ul>
<li>
Connection_Interval to be used for the Conn_Interval_Min and Conn_Interval_Max parameters of discovery/connection procedure APIs (i.e. aci_gap_create_connection() API) </li>
<li>
CE_Length = int(CE_Length_ms/0.625) to be used for the Minimum_CE_Length and Maximum_CE_Length parameters of connectable procedure APis (i.e: aci_gap_create_connection() API) </li>
<li>
Scan_Interval = int(Scan_Interval_ms/0.625) to be used for the LE_Scan_Interval parameter of discovery/connection procedure APIs (i.e. aci_gap_start_general_discovery_proc(), aci_gap_create_connection() API) </li>
<li>
Scan_Window = int(Scan_Window_ms/0.625) to be used for LE_Scan_Window parameter of discovery/connection procedure APIs(i.e. aci_gap_start_general_discovery_proc(), aci_gap_create_connection() API) </li>
<li>
Additional_time = 0 (no additional time added: it provides the best data throughput)</li>
</ul>
</li>
</ul>
<ul>
<li><b> Simultaneously Advertising/Scanning and Master of multiple Slaves</b>: <ul>
<li>
One Master/Slave device connected as a Slave to one Master device and as a Master up to 7 Slaves devices</li>
</ul>
</li>
<li>User must define the following input parameters for the formula: <ul>
<li>
Num_Masters = 1 </li>
<li>
Num_Slaves &lt;=7 (number of slave devices to be supported) </li>
<li>
Scan_Window = &lt;value&gt; (&lt;value&gt; is the scan window value in ms used by Master_Slave device during its scanning operations for discovering each Slave device) </li>
<li>
Additional_time = 0 (no additional time added: it provides the best data throughput). User could add a value greater than 0, if he wants to improve the power consumption profile. </li>
</ul>
</li>
</ul>
<ul>
<li>This implies to use the formula as follow: <ul>
<li>
<b> GET_Master_Slave_device_connection_parameters(1, 7,20,0)</b> </li>
</ul>
</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_3.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 3: Master_Slave device: multiple connections to up 7 Slave devices &amp; 1 Master device </b>  </td></tr>
</table>
<ul>
<li>The formula returns the following parameters to be used on the BLE APIs: <ul>
<li>
Connection_Interval to be used for the Conn_Interval_Min and Conn_Interval_Max parameters of discovery/connection procedure APIs (i.e. aci_gap_create_connection() API) </li>
<li>
CE_Length = int(CE_Length_ms/0.625) to be used for the Minimum_CE_Length and Maximum_CE_Length parameters of connectable procedure APIs (i.e: aci_gap_create_connection() API) </li>
<li>
Advertising_Interval to be used for the Advertising_Interval_Min, Advertising_Interval_Max of discoverable/connectable mode APIs (i.e. aci_gap-set_discoverable() API) </li>
<li>
Scan_Interval = int(Scan_Interval_ms/0.625) to be used for the LE_Scan_Interval parameter of discovery/connection procedure APIs (i.e. aci_gap_start_general_discovery_proc(), aci_gap_create_connection() API) </li>
<li>
Scan_Window = int(Scan_Window_ms/0.625) to be used for LE_Scan_Window parameter of discovery/connection procedure APIs (i.e. aci_gap_start_general_discovery_proc(), aci_gap_create_connection() API) </li>
<li>
Additional_time = 0 (no additional time added: it provides the best data throughput) </li>
</ul>
</li>
</ul>
<ul>
<li><b> One Master/Slave device connected as a Slave to two Master devices and as a Master up to 6 Slaves devices </b> </li>
<li>User must define the following input parameters for the formula:<ul>
<li>
Num_Masters = 2 </li>
<li>
Num_Slaves &lt;=6 (number of slave devices to be supported) </li>
<li>
Scan_Window = &lt;value&gt; (&lt;value&gt; is the scan window value in ms used by Master_Slave device during its scanning operations for discovering each Slave device) </li>
<li>
Additional_time = 0 (no additional time added: it provides the best data throughput). User could add a value greater than 0, if he wants to improve the power consumption profile. </li>
</ul>
</li>
</ul>
<ul>
<li>This implies to use the formula as follow: <ul>
<li>
<b>GET_Master_Slave_device_connection_parameters(2, 6,20,0)</b> </li>
</ul>
</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_4.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 4: Master_Slave device: multiple connections to up 6 Slave devices &amp; 2 Master devices </b>  </td></tr>
</table>
<ul>
<li>The formula returns the following parameters to be used on the BLE APIs:<ul>
<li>
Connection_Interval to be used for the Conn_Interval_Min and Conn_Interval_Max parameters of discovery/connection procedure APIs (i.e. aci_gap_create_connection() API) </li>
<li>
CE_Length = int(CE_Length_ms/0.625) to be used for the Minimum_CE_Length and Maximum_CE_Length parameters of connectable procedure APIs (i.e: aci_gap_create_connection() API) </li>
<li>
Advertising_Interval to be used for the Advertising_Interval_Min, Advertising_Interval_Max of discoverable/connectable mode APIs (i.e. aci_gap-set_discoverable() API) </li>
<li>
Scan_Interval = int(Scan_Interval_ms/0.625) to be used for the LE_Scan_Interval parameter of discovery/connection procedure APIs (i.e. aci_gap_start_general_discovery_proc(), aci_gap_create_connection() API) </li>
<li>
Scan_Window = int(Scan_Window_ms/0.625) to be used for LE_Scan_Window parameter of discovery/connection procedure APIs (i.e. aci_gap_start_general_discovery_proc(), aci_gap_create_connection() API) </li>
<li>
Additional_time = 0 (no additional time added: it provides the best data throughput)\ </li>
</ul>
</li>
</ul>
<ul>
<li>A specific demo application for Master_Slave and Master device roles are provided on Project/BLE_Examples/BLE_MS_Formula/ folder. They allow to demonstrate the 3 basic scenarios based on the highlighted formula. </li>
<li>Further two scripts are provided: <ol>
<li>
Slaves.py: it allows to configure up to Num_Slaves BlueNRG-1, BlueNRG-2, BlueNRG-MS devices as Slaves to be connected to Master_Slave device. At runtime user is requested to insert the expected number of Master devices (Num_Masters) and number of slaves devices (Num_Slaves) to be configured according to the selected scenario. It must be executed using the BlueNRG Script Launcher available on BlueNRG GUI SW package (STSW-BNRGUI). </li>
<li>
Master.py (as alternative to the Master role): this script allows to configure a BlueNRG-1, BlueNRG-2 device as master device to be connected to the Master_Slave device (Num_Masters &gt;0). As Master role, user can use one or two smarthphones devices for connecting as master to the Master_Slave device.</li>
</ol>
</li>
</ul>
<ul>
<li><b>How to run? </b>: <ul>
<li>
Connect a BlueNRG-1,2 platform (STEVAL-IDB007Vx (x=1,2) or STEVAL-IDB008Vx (x=1,2)) to a PC USB port and download the Project/BLE_Examples/BLE_MS_Formula/[BlueNRG-1/BlueNRG-2]/Master_Slave/Exe/BLE_Master_Slave.hex binary image </li>
<li>
Open an hyper terminal with settings [115200,8,N,1] and reset the device </li>
<li>
At this stage, Master_Slave device looks for Num_Slaves devices for connecting to each of them and enabling a characteristic notification which is notified from each slave device to Master_Slave device. </li>
<li>
Connect the selected Num_Slaves slaves platforms to PC USB ports and open a DOS shell (devices must be loaded with the required application image: DTM for BlueNRG-1, BlueNRG-2 devices). Then run the BlueNRG_Script_Launcher.exe as follow: <ul>
<li>
BlueNRG_Script_Launcher.exe –s &lt;user script folder&gt; Slaves.py </li>
</ul>
</li>
<li>
Once Master_Slave device connects to Num_Slaves devices, these devices notify characteristic value as follow: &lt; slave_index &gt;&lt; counter_value &gt;, where slave_index is one byte in the range [1 - Num_Slaves], and counter_value is a 2 bytes integer counter starting from 0. </li>
<li>
Once connections are done, user can select one or two master devices (according to the selected Num_Masters value), for connecting to the Master_Slave device (advertising name = advscan). </li>
<li>
This operation can be done by downloading the Project/BLE_Examples/BLE_MS_Formula/[BlueNRG-1/BlueNRG-2]/Master/Exe/BLE_Master.hex binary image or by running the Master.py script using BlueNRG GUI on another BlueNRG-1, BlueNRG-2 platform. </li>
<li>
If Num_Masters = 2, as Master device user can also take a smarthphone and a simple BLE application: just look for advscan device and connect to it. Once connected, user can enable the characteristic notification on Master_Slave device. </li>
<li>
Once the connections are done and the characteristic notification is enabled on Master_Slave device , a notification cycle is also started from Master_Slave device to each connected master device: <ul>
<li>
The slave_index component of each received &lt; slave_index &gt;&lt; counter_value &gt; notification, is also notified from the Master_Device to each connected master device, in order to have evidence, at master side, of which slave the notified value belongs to.</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>NOTES: <ol>
<li>
As described on Slave of Multiple Masters Guidelines, SoMM2 condition, when Master_Slave device connects to one or two Master devices as a Slave, the Slave slot position within the Anchor Period is predictable but not constant since it is decided by the Master devices. As consequence, Slave slots can overlap in time each other as well as with other Master slots: a round-robin policy by BLE stack whenever a collision is predicted between two Slave slots or two Master slots. This could lead to some notification to be skipped during the notification flow, due to the round robin policy. </li>
<li>
When Master_Slave device connects to a Master device, it starts a connection updated operation in order to update the Master connection interval to a value consistent (greater than) with the Connection_Interval calculated through the <b>GET_Master_Slave_device_connection_parameters()</b> formula. </li>
</ol>
</li>
</ul>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Copyright &copy; 2020 by STMicrolectronics. All rights reserved.<br>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
